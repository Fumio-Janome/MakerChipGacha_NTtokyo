# メーカーチップガチャ for NT東京2025

<span style="color:red">
※本内容は全見直しのこと
<br>
----------------------------------------------------------------------------------------------------------------------------------------
</span>

ESP32-C3 Mini開発ボードとLCDディスプレイ(ST7789V3 SPI)を使用してコインセレクタのパルスを読み取り、投入されたコインを計数・表示する貯金箱システムです。

## 機能

- **ST7789V3 LCD（172×320ピクセル）による視覚的な貯金状況表示**
- **2列レイアウトによる効率的なコイン情報表示**
- **BGR色順序対応による正確な色表示**
- **非同期LCD表示システムによるパルス検知への影響排除**
- **高速・高精度なコインセレクタのパルス信号検出** (最高優先度処理)
- **日本硬貨6種類の完全対応** (1円、5円、10円、50円、100円、500円)
- **実時間パルス品質分析** による誤検出防止
- **1秒間隔の連続投入対応** による実用的な使用感
- **NVS（不揮発性ストレージ）による貯金データの永続化**
- **再起動後の貯金データ自動復元**
- **リセットボタンによる貯金データのクリア機能**
- **排他制御による連続投入時の安定性保証**
- **FreeRTOSタスクベース設計による高いレスポンス性能**

<span style="color:red">
※連続投入ではコインセレクタ上は検知され貯金されてしまうが、パルスが連続してしまうため本ファームウェアとしては対象外コインとして処理され貯金額には合算されません。<br>
(連続投入：コインセレクタ側でパルスを出していると思われるビープON鳴動中に次のコインを投入)
</span>


## 硬貨判定仕様

| 硬貨 | パルス数 | 実パルス特性 | 認識時間 | 許容範囲 |
|------|----------|-------------|----------|----------|
| 1円  | 2パルス  | 135ms/パルス | ~270ms  | ±1パルス |
| 5円  | 3パルス  | 135ms/パルス | ~405ms  | ±1パルス |
| 10円 | 4パルス  | 135ms/パルス | ~540ms  | ±1パルス |
| 50円 | 5パルス  | 135ms/パルス | ~675ms  | ±1パルス |
| 100円| 6パルス  | 135ms/パルス | ~810ms  | ±1パルス |
| 500円| 7パルス  | 135ms/パルス | ~945ms  | ±1パルス |

### パルス品質検証
- **パルス幅**: 30ms (LOW時間: 100ms)
- **パルス間隔**: 100-200ms (平均135ms)
- **変動許容**: 平均間隔の1.5倍以内
- **単一パルス対応**: 1パルスも有効として処理
- **距離ベース判定**: ±1パルス範囲で最適マッチ

## ハードウェア要件

- **ESP32-C3 Mini** 開発ボード
- **ST7789V3 LCD ディスプレイ** (172×320ピクセル、SPI接続)
- コインセレクタ（パルス出力タイプ）
- ジャンパーワイヤー

## 配線

### コインセレクタ接続
| ESP32-C3ピン | 接続先 | 説明 |
|-------------|--------|------|
| GPIO4 | コインセレクタのパルス出力 | プルアップ抵抗内蔵、NEGEDGE割り込み |
| GPIO9 | 内蔵BOOTボタン | リセット機能用（ESP32-C3 Super Mini） |
| GND | コインセレクタのGND | 共通グランド |
| 3.3V | コインセレクタの電源 | 必要に応じて |

### ST7789V3 LCD接続
| ESP32-C3ピン | LCDピン | 説明 |
|-------------|---------|------|
| GPIO6 | SDA (MOSI) | SPI データ線 |
| GPIO7 | SCL (CLK) | SPI クロック線 |
| GPIO10 | CS | SPI チップセレクト |
| GPIO2 | DC | データ/コマンド切り替え |
| GPIO3 | RST | リセット線 |
| GPIO1 | BLK | バックライト制御 |
| 3.3V | VCC | 電源 |
| GND | GND | グランド |

**注意**: 
- ESP32-C3 Super MiniはRISC-Vアーキテクチャを採用
- ST7789V3 LCDはBGR色順序を使用（通常のRGBとは異なる）
- GPIO9がBOOTボタン（ESP32-C3 Super Mini仕様）
- LCD表示は非同期処理でパルス検知に影響しない設計
- パルス検知は最高優先度（20）で確実に動作

## システム特性

### LCD表示機能
- **ST7789V3対応**: 172×320ピクセル高解像度表示
- **BGR色順序**: 正確な色表示のためのカラー変換
- **2列レイアウト**: 効率的なコイン情報配置
- **非同期更新**: パルス検知に影響しない独立タスク処理
- **青緑背景**: 視認性の高い配色設計

### 高速処理設計
- **最高優先度**: コインセレクタタスク（優先度20）
- **低優先度LCD**: LCD表示タスク（優先度5）で干渉防止
- **パルス取りこぼし防止**: 絶対的な検知精度保証
- **2秒初期化遅延**: コインセレクタの安定化待機

### 連続投入対応
- **スレッドセーフ**: mutex保護によるNVS同期処理
- **安定性**: 連続投入時のリブート防止機能
- **品質管理**: リアルタイムパルス品質解析

## ビルドと実行

### 前提条件
- ESP-IDF v5.0以上がインストールされていること
- VS CodeにESP-IDF拡張機能がインストールされていること

### ビルド手順

1. VS Codeでプロジェクトフォルダを開く
2. `Ctrl+Shift+P` でコマンドパレットを開き、「ESP-IDF: Build Project」を選択
3. または以下のコマンドを実行：
   ```bash
   idf.py build
   ```

### フラッシュ

1. ESP32ボードをUSBで接続
2. `Ctrl+Shift+P` でコマンドパレットを開き、「ESP-IDF: Flash」を選択
3. または以下のコマンドを実行：
   ```bash
   idf.py -p COMx flash monitor
   ```

## 設定とパラメータ

### LCD表示設定
`main/main.c` のLCD関連パラメータ：
```c
// ST7789V3 LCD GPIO定義（ESP32-C3 Super Mini用）
#define LCD_MOSI_PIN GPIO_NUM_6         // SPI MOSI
#define LCD_CLK_PIN GPIO_NUM_7          // SPI CLK
#define LCD_CS_PIN GPIO_NUM_10          // SPI CS
#define LCD_DC_PIN GPIO_NUM_2           // Data/Command
#define LCD_RST_PIN GPIO_NUM_3          // Reset
#define LCD_BLK_PIN GPIO_NUM_1          // Backlight

// 表示サイズとオフセット
#define LCD_WIDTH 172
#define LCD_HEIGHT 320
#define COLSTART 34                     // 34ピクセル左オフセット
```

### FreeRTOSタスク優先度設定
```c
// タスク優先度（数値が大きいほど高優先度）
coin_selector_task: 優先度20（最高優先度）
lcd_display_task: 優先度5（低優先度）
```

### パルス品質設定
```c
#define QUALITY_FACTOR 1.5              // 変動許容係数
#define MIN_PULSE_DURATION_MS 100       // 最小パルス期間
#define MAX_PULSE_DURATION_MS 200       // 最大パルス期間
```

これらの設定により、実際のコインセレクタの特性（30ms パルス幅、100ms LOW時間、135ms周期）に最適化されています。

### GPIO ピンの変更
`main/main.c` の以下の定義を変更してください：
```c
#define COIN_SELECTOR_PIN GPIO_NUM_4    // コインセレクタのピン
// LCD関連のピンは上記のLCD表示設定を参照
```

### デバウンス時間の調整
```c
#define DEBOUNCE_TIME_MS 5              // ミリ秒単位（デフォルト5ms・高速化）
```

### パルスタイムアウトの調整
```c
#define PULSE_TIMEOUT_MS 400            // パルス列終了判定時間（デフォルト400ms・2パルス分）
```

## 動作

1. **電源投入時**：
   - システム初期化
   - **前回の貯金データがNVSから自動復元**
   - **ST7789V3 LCD初期化**
   - **非同期LCD表示タスク開始**（優先度5）
   - **コインセレクタタスク開始**（最高優先度20）

2. **LCD表示**：
   - **2列レイアウト**で各硬貨の枚数を表示
   - **青緑背景**による視認性の高い表示
   - **合計金額**と**総枚数**をリアルタイム更新
   - **BGR色順序**による正確な色表示

3. **コイン投入時**：
   - **最高優先度**での高速パルス信号検出
   - リアルタイムパルス品質解析
   - パルス数に基づく硬貨種類判定（±1パルス許容）
   - 硬貨別カウントと合計金額を更新
   - **スレッドセーフなNVS自動保存**
   - **非同期LCD表示更新**（パルス検知に影響なし）
   - シリアルモニターに結果表示

4. **リセット機能**：
   - ESP32-C3 Super Mini上のBOOTボタン（GPIO9）を3秒間長押し
   - 全ての貯金データがクリアされ、LCD表示もリセット

## トラブルシューティング

### LCD表示に関する問題
- **画面に何も表示されない場合**：
  - SPI配線を確認（MOSI, CLK, CS, DC, RST, BLK）
  - 電源電圧を確認（3.3V）
  - シリアルモニターでLCD初期化ログを確認
  - CS（GPIO10）の接続を特に確認
- **色が正しく表示されない場合**：
  - ST7789V3はBGR色順序を使用（RGB変換済み）
  - `rgb565()`関数が自動的にBGR変換を行います
- **表示が乱れる場合**：
  - SPI信号の安定性を確認
  - ジャンパーワイヤーの長さを短くしてみてください
  - CS信号の品質を確認

### コインが検出されない場合
- 配線を確認してください（GPIO4がコインセレクタのパルス出力に接続）
- コインセレクタの電源電圧を確認してください
- パルス信号の極性を確認してください（NEGEDGE検出）
- **パルス検知は最高優先度で動作し、LCD表示に影響されません**

### パルス数が正しく検出されない場合
- シリアルモニターで統計情報を確認（平均パルス間隔など）
- パルス品質スコアを確認（1.0に近いほど良好）
- 実際のタイミング特性：
  - パルス幅: 30ms（実測値）
  - LOW時間: 100ms（実測値）
  - パルス周期: 135ms（実測値）
- 連続投入時の間隔は1秒以上推奨

### システムが不安定な場合
- NVSパーティションが破損している可能性があります
- フラッシュを完全消去してから再フラッシュしてください：
  ```bash
  idf.py erase-flash
  idf.py flash
  ```

### 硬貨の種類が正しく判定されない場合
- 各硬貨のパルス数設定を確認（1円=2、5円=3、10円=4、50円=5、100円=6、500円=7）
- ±1パルス許容範囲を考慮した判定ロジック
- 単一パルス（1パルス）も有効として処理
- 距離ベース判定による最適マッチング
- コインセレクタの較正が必要な場合があります

## システムの最適化ポイント

### 高速応答の実現
- **超軽量ISR**: 割り込みハンドラを最小限に抑制
- **最適なデバウンス**: 5msの超短時間設定
- **効率的なキュー**: タスク間通信の高速化
- **スレッドセーフ**: mutex保護による安全なNVS操作
- **非同期LCD**: LCD表示はパルス検知に一切影響しない独立処理

### 実世界対応
- **実測値ベース**: 実際のコインセレクタ特性に基づく設定
- **品質解析**: リアルタイムパルス品質監視
- **統計情報**: パルス間隔の詳細解析
- **連続対応**: 1秒間隔投入の完全サポート

## カスタマイズ

このプロジェクトは高性能な貯金箱機能を提供します。以下のような拡張が可能です：

- **LCD表示のカスタマイズ**: 色テーマやレイアウトの変更
- **フォント追加**: 5×7ビットマップフォントの拡張
- Wi-Fi接続による遠隔監視
- さらなる硬貨種類対応
- データのクラウド保存
- WebサーバーによるWeb UI
- **他のLCDディスプレイ対応**: ST7735やILI9341など

## 使用方法

1. **通常使用**: 
   - コインを投入すると最高優先度で即座に検知
   - **LCD画面**に2列レイアウトでコイン情報を表示
   - **青緑背景**で見やすい表示
   - 貯金データは自動保存

2. **電源再投入**: 
   - 前回の貯金データが自動復元
   - **LCD表示も前回の状態を復元**

3. **表示確認**: 
   - **各硬貨の枚数**を2列で表示
   - **合計金額**と**総枚数**をリアルタイム表示
   - シリアルモニターで詳細ログも確認可能

4. **データリセット**: 
   - ESP32-C3 Super MiniのBOOTボタン（GPIO9）を3秒間長押し
   - **LCD表示もクリアされます**

## パフォーマンス仕様

### 表示性能
- **LCD解像度**: 172×320ピクセル（ST7789V3）
- **色深度**: RGB565（65,536色）
- **更新方式**: 非同期タスクによる独立更新
- **表示遅延**: パルス検知に影響なし

### 処理性能
- **パルス検知**: 最高優先度（20）による確実な検出
- **LCD表示**: 低優先度（5）による非干渉設計
- **連続投入**: 1秒間隔で安定動作
- **精度**: ±1パルス許容による高精度判定
- **安定性**: FreeRTOSタスク分離による高い安定性

## 注意事項

- **ESP32-C3アーキテクチャ**: RISC-V 32bit CPU（従来のXtensaとは異なる）
- **ST7789V3 LCD仕様**: BGR色順序、34ピクセルオフセット対応済み
- **BOOTボタンのピン**: ESP32-C3 Super MiniではGPIO9固定
- **タスク優先度**: パルス検知が最高優先度、LCD表示は低優先度で干渉防止
- **連続投入**: 1秒間隔での使用を推奨（パルス検知精度保証）
- **LCD表示**: 非同期処理でパルス検知に一切影響しない設計

## トラブルシューティング

### BOOTボタンが反応しない場合
1. シリアルモニターでボタン状態ログを確認
2. 開発ボードの仕様書でBOOTボタンのGPIOピンを確認
3. 必要に応じてGPIO0に変更してテスト

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。
